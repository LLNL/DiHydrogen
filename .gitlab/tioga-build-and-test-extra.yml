##############################################################################
# Copyright (c) 2022, Lawrence Livermore National Security, LLC and RADIUSS
# project contributors. See the COPYRIGHT file for details.
#
# SPDX-License-Identifier: (MIT)
##############################################################################

# With GitLab CI, included files cannot be empty.
variables:
  INCLUDED_FILE_CANNOT_BE_EMPTY: "True"

## Template for extra jobs defined by the project.
#<job-name (usually spec or description)>:
#  variables:
#    SPEC: "<spack spec without package name>"
#  extends: .build_and_test_on_ruby

rocmcc_5_4_3_hip:
  variables:
    ON_TIOGA: "ON"
    GCOVR: "/usr/workspace/brain/katie/h2_ci_env_tioga/bin/gcovr"
    LLVM_COV: "/opt/rocm-5.4.3/llvm/bin/llvm-cov"
    BUILD_DIR: "build_dihydrogen-linux-rhel8-zen2-rocmcc@5.4.3"
  after_script:
    - find -name '*.gcno' -exec ${LLVM_COV} gcov -b -c -f -r -s
      ${CI_PROJECT_DIR} {} \;
    - ${GCOVR} -g -k --cobertura-pretty --exclude-unreachable-branches --print-summary
      -o tioga-coverage.xml
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/*.xml
      - ${CI_PROJECT_DIR}/*.cmake
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/Testing/Temporary/*.log
    name: ${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA}
    expire_in: 2 days
    reports:
      junit: ${CI_PROJECT_DIR}/*_junit.xml
      coverage_report:
        coverage_format: cobertura
        path: ${CI_PROJECT_DIR}/tioga-coverage.xml
  extends: .build_and_test_on_tioga

rocmcc_5_4_3_hip_distconv:
  variables:
    ON_TIOGA: "ON"
    GCOVR: "/usr/workspace/brain/katie/h2_ci_env_tioga/bin/gcovr"
    LLVM_COV: "/opt/rocm-5.4.3/llvm/bin/llvm-cov"
    BUILD_DIR: "build_dihydrogen-linux-rhel8-zen2-rocmcc@5.4.3"
    SPEC: "${PROJECT_TIOGA_VARIANTS} +rocm amdgpu_target=gfx90a +distconv %rocmcc@5.4.3 ^hip@5.4.3 ${PROJECT_TIOGA_DEPS}"
  after_script:
    - find -name '*.gcno' -exec ${LLVM_COV} gcov -b -c -f -r -s
      ${CI_PROJECT_DIR} {} \;
    - ${GCOVR} -g -k --cobertura-pretty --exclude-unreachable-branches --print-summary
      -o tioga-coverage.xml
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/*.xml
      - ${CI_PROJECT_DIR}/*.cmake
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/Testing/Temporary/*.log
    name: ${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA}
    expire_in: 2 days
    reports:
      junit: ${CI_PROJECT_DIR}/*_junit.xml
      coverage_report:
        coverage_format: cobertura
        path: ${CI_PROJECT_DIR}/tioga-coverage.xml
  extends: .build_and_test_on_tioga

# Disabled tests

cce_15_0_1:
  variables:
    ON_TIOGA: "OFF"
  extends: .build_and_test_on_tioga
##############################################################################
# Copyright (c) 2022, Lawrence Livermore National Security, LLC and RADIUSS
# project contributors. See the COPYRIGHT file for details.
#
# SPDX-License-Identifier: (MIT)
##############################################################################

# With GitLab CI, included files cannot be empty.
variables:
  INCLUDED_FILE_CANNOT_BE_EMPTY: "Template"

## True for extra jobs defined by the project.
#<job-name (usually spec or description)>:
#  variables:
#    SPEC: "<spack spec without package name>"
#  extends: .build_and_test_on_ruby

.load_modules:
  extends: [.custom_build_and_test, .on_lassen]
  before_script:
    - module load cmake/3.23.1

clang_12_0_1_gcc_8_3_1_cuda_10_1_243:
  variables:
    ON_LASSEN: "OFF"
  extends: .build_and_test_on_lassen

clang_12_0_1_gcc_8_3_1_cuda_11_2_0:
  variables:
    ON_LASSEN: "ON"
    GCOVR: "/usr/workspace/brain/katie/h2_ci_env_lassen/bin/gcovr"
    LLVM_COV: "/usr/tce/packages/clang/clang-12.0.1/bin/llvm-cov"
    BUILD_DIR: "build_dihydrogen-linux-rhel7-ppc64le-clang@12.0.1.gcc.8.3.1"
  after_script:
    - find -name '*.gcno' -exec ${LLVM_COV} gcov -b -c -f -r -s
      ${CI_PROJECT_DIR} {} \;
    - ${GCOVR} -g -k --cobertura-pretty --exclude-unreachable-branches --print-summary
      -o lassen-coverage.xml
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/*.xml
      - ${CI_PROJECT_DIR}/*.cmake
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/Testing/Temporary/*.log
    name: ${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA}
    expire_in: 2 days
    reports:
      junit: ${CI_PROJECT_DIR}/*_junit.xml
      coverage_report:
        coverage_format: cobertura
        path: ${CI_PROJECT_DIR}/lassen-coverage.xml
  extends: .build_and_test_on_lassen

clang_14_0_5_gcc_8_3_1_cuda_11_7_0:
  variables:
    ON_LASSEN: "ON"
    GCOVR: "/usr/workspace/brain/katie/h2_ci_env_lassen/bin/gcovr"
    LLVM_COV: "/usr/tce/packages/clang/clang-14.0.5/bin/llvm-cov"
    BUILD_DIR: "build_dihydrogen-linux-rhel7-ppc64le-clang@14.0.5.gcc.8.3.1"
  after_script:
    - find -name '*.gcno' -exec ${LLVM_COV} gcov -b -c -f -r -s
      ${CI_PROJECT_DIR} {} \;
    - ${GCOVR} -g -k --cobertura-pretty --exclude-unreachable-branches --print-summary
      -o lassen-coverage.xml
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/*.xml
      - ${CI_PROJECT_DIR}/*.cmake
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/Testing/Temporary/*.log
    name: ${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA}
    expire_in: 2 days
    reports:
      junit: ${CI_PROJECT_DIR}/*_junit.xml
      coverage_report:
        coverage_format: cobertura
        path: ${CI_PROJECT_DIR}/lassen-coverage.xml
  extends: .build_and_test_on_lassen

xl_2022_08_19_gcc_8_3_1_cuda_11_2_0:
  variables:
    ON_LASSEN: "OFF"
  extends: .build_and_test_on_lassen

xl_2022_08_19_gcc_8_3_1_cuda_11_7_0:
  variables:
    ON_LASSEN: "OFF"
  extends: .build_and_test_on_lassen

gcc_8_3_1_cuda_11_7_0:
  variables:
    ON_LASSEN: "OFF"
  extends: .build_and_test_on_lassen
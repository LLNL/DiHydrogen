##############################################################################
# Copyright (c) 2022, Lawrence Livermore National Security, LLC and RADIUSS
# project contributors. See the COPYRIGHT file for details.
#
# SPDX-License-Identifier: (MIT)
##############################################################################

# With GitLab CI, included files cannot be empty.
variables:
  INCLUDED_FILE_CANNOT_BE_EMPTY: "True"

## Template for extra jobs defined by the project.
#<job-name (usually spec or description)>:
#  variables:
#    SPEC: "<spack spec without package name>"
#  extends: [.build_and_test_on_ruby]

rocmcc_5_4_3_hip:
  variables:
    ON_CORONA: "ON"
    GCOVR: "/usr/workspace/brain/katie/h2_ci_env_corona/bin/gcovr"
    LLVM_COV: "/opt/rocm-5.4.3/llvm/bin/llvm-cov"
    BUILD_DIR: "build_dihydrogen-linux-rhel8-zen2-rocmcc@5.4.3"
    SPEC: "${PROJECT_CORONA_VARIANTS} ~al +rocm amdgpu_target=gfx906 %rocmcc@5.4.3 ^hip@5.4.3 ${PROJECT_CORONA_DEPS}"
  after_script:
    - find -name '*.gcno' -exec ${LLVM_COV} gcov -b -c -f -r -s
      ${CI_PROJECT_DIR} {} \;
    - ${GCOVR} -g -k --cobertura-pretty --exclude-unreachable-branches --print-summary
      -o corona-coverage.xml
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/*.xml
      - ${CI_PROJECT_DIR}/*.cmake
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/Testing/Temporary/*.log
    name: ${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA}
    expire_in: 2 days
    reports:
      junit: ${CI_PROJECT_DIR}/*_junit.xml
      coverage_report:
        coverage_format: cobertura
        path: ${CI_PROJECT_DIR}/corona-coverage.xml
  extends: [.build_and_test_on_corona]

rocmcc_5_4_3_hip_distconv:
  variables:
    ON_CORONA: "ON"
    GCOVR: "/usr/workspace/brain/katie/h2_ci_env_corona/bin/gcovr"
    LLVM_COV: "/opt/rocm-5.4.3/llvm/bin/llvm-cov"
    BUILD_DIR: "build_dihydrogen-linux-rhel8-zen2-rocmcc@5.4.3"
    SPEC: "${PROJECT_CORONA_VARIANTS} +rocm +distconv +al amdgpu_target=gfx906 %rocmcc@5.4.3 ^hip@5.4.3 ${PROJECT_CORONA_DEPS}"
  after_script:
    - find -name '*.gcno' -exec ${LLVM_COV} gcov -b -c -f -r -s
      ${CI_PROJECT_DIR} {} \;
    - ${GCOVR} -g -k --cobertura-pretty --exclude-unreachable-branches --print-summary
      -o corona-coverage.xml
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/*.xml
      - ${CI_PROJECT_DIR}/*.cmake
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/Testing/Temporary/*.log
    name: ${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA}
    expire_in: 2 days
    reports:
      junit: ${CI_PROJECT_DIR}/*_junit.xml
      coverage_report:
        coverage_format: cobertura
        path: ${CI_PROJECT_DIR}/corona-coverage.xml
  extends: [.build_and_test_on_corona]

# Disabled tests

rocmcc_5_4_1_hip:
  variables:
    ON_CORONA: "OFF"
    GCOVR: "/usr/workspace/brain/katie/h2_ci_env_corona/bin/gcovr"
    LLVM_COV: "/opt/rocm-5.4.1/llvm/bin/llvm-cov"
    BUILD_DIR: "build_dihydrogen-linux-rhel8-zen2-rocmcc@5.4.1"
  after_script:
    - find -name '*.gcno' -exec ${LLVM_COV} gcov -b -c -f -r -s
      ${CI_PROJECT_DIR} {} \;
    - ${GCOVR} -g -k --cobertura-pretty --exclude-unreachable-branches --print-summary
      -o corona-coverage.xml
  coverage: /^\s*lines:\s*\d+.\d+\%/
  artifacts:
    when: always
    paths:
      - ${CI_PROJECT_DIR}/*.xml
      - ${CI_PROJECT_DIR}/*.cmake
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/Testing/Temporary/*.log
    name: ${CI_JOB_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA}
    expire_in: 2 days
    reports:
      junit: ${CI_PROJECT_DIR}/*_junit.xml
      coverage_report:
        coverage_format: cobertura
        path: ${CI_PROJECT_DIR}/corona-coverage.xml
  extends: [.build_and_test_on_corona]